<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Premium EMI Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
    .marquee {
      background-color: #004085;
      color: white;
      padding: 10px 20px;
      font-weight: bold;
      font-size: 16px;
      overflow: hidden;
      position: relative;
    }
    .marquee-text {
      display: inline-block;
      white-space: nowrap;
      animation: scroll-left 15s linear infinite;
    }
    @keyframes scroll-left {
      0% { transform: translateX(100%); }
      100% { transform: translateX(-100%); }
    }
    .interest-badge {
      font-size: 0.85rem;
      padding: 0.25rem 0.5rem;
    }
    .emi-table th {
      background-color: #2c3e50;
      color: white;
    }
    .summary-card {
      border-left: 4px solid #1abc9c;
      border-radius: 8px;
      padding: 1rem;
      background-color: #f8f9fa;
    }
    .payment-form {
      background-color: #e9f7ef;
      border-radius: 8px;
      padding: 1.5rem;
    }
    .payment-btn {
      transition: all 0.3s ease;
    }
    .payment-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    /* Print-specific styles */
    @media print {
      body {
        padding: 20px !important;
        font-size: 12pt;
      }
      .marquee, .no-print, .payment-form, .btn {
        display: none !important;
      }
      .card {
        box-shadow: none !important;
        border: none !important;
      }
      .card-header {
        background-color: #f8f9fa !important;
        color: #000 !important;
        border-bottom: 2px solid #000 !important;
      }
      .emi-table {
        font-size: 10pt;
      }
      .print-header {
        display: block !important;
        text-align: center;
        margin-bottom: 20px;
        border-bottom: 2px solid #000;
        padding-bottom: 10px;
      }
      .print-footer {
        display: block !important;
        text-align: center;
        margin-top: 30px;
        padding-top: 10px;
        border-top: 1px solid #ccc;
        font-size: 9pt;
      }
    }
    
    .print-header, .print-footer {
      display: none;
    }


    @media print {
  body {
    padding: 20px !important;
    font-size: 12pt;
  }
  .marquee, .no-print, .payment-form, .btn {
    display: none !important;
  }
  .card {
    box-shadow: none !important;
    border: none !important;
  }
  .card-header {
    background-color: #f8f9fa !important;
    color: #000 !important;
    border-bottom: 2px solid #000 !important;
  }
  .emi-table {
    font-size: 10pt;
  }
  .print-header, .print-footer {
    display: block !important;
  }
}




  </style>
</head>
<body>

  <!-- ðŸ”” Marquee Notice -->
  <div class="marquee">
    <div class="marquee-text">
      ðŸš¨ Important: EMI is calculated with interest first. Skipped months add up interest! | Pay early, save more. 
      | Interest Rate: {{ loan.interest_rate }}% | Loan Amount: â‚¹{{ loan.loan_amount }}
    </div>
  </div>

  <div class="container mt-4">
    <div class="card shadow-lg">
      <!-- Print header (only visible when printing) -->
      <div class="print-header">
        <h2>GPS Teacher Co-Operative Bank</h2>
        <h3>EMI Payment Statement</h3>
        <p>Loan ID: {{ loan.id }} | Customer: {{ loan.full_name }}</p>
        <p>Statement Date: {{ current_date }}</p>
      </div>
      
      <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
        <h3 class="mb-0">ðŸ’° Premium EMI Dashboard</h3>
        <span>Loan ID: {{ loan.id }}</span>
      </div>
      
      <div class="card-body">
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        <!-- ðŸ’¼ Loan Summary -->
        <div class="row mb-4">
          <div class="col-md-6">
            <div class="summary-card">
              <h5><i class="bi bi-person-circle"></i> Customer Details</h5>
              <div class="d-flex justify-content-between">
                <div>
                  <strong>Name:</strong> {{ loan.full_name }}<br>
                  <strong>Phone:</strong> {{ loan.phone }}<br>
                  <strong>Loan Type:</strong> 
                  <span class="badge 
                    {% if loan.loan_type == 'Personal' %}bg-info
                    {% elif loan.loan_type == 'Home' %}bg-warning text-dark
                    {% elif loan.loan_type == 'Education' %}bg-primary
                    {% else %}bg-secondary{% endif %}">
                    {{ loan.loan_type }}
                  </span>
                </div>
                <div>
                  <strong>Start Date:</strong> {{ loan.start_date }}<br>
                  <strong>End Date:</strong> {{ loan.end_date }}
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="summary-card">
              <h5><i class="bi bi-cash-coin"></i> Financial Summary</h5>
              <div class="d-flex justify-content-between">
                <div>
                  <strong>Principal:</strong> â‚¹{{ loan.loan_amount }}<br>
                  <strong>Paid:</strong> â‚¹{{ loan.paid_amount }}<br>
                  <strong>Remaining:</strong> 
                  <span class="fw-bold {% if remaining_principal > 0 %}text-danger{% else %}text-success{% endif %}">
                    â‚¹{{ remaining_principal }}
                  </span>
                </div>
                <div>
                  <strong>Interest Rate:</strong> {{ loan.interest_rate }}%<br>
                  <strong>Daily EMI:</strong> â‚¹{{ loan.insert_amount }}<br>
                  <strong>Total Days:</strong> {{ loan.loan_term }}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ðŸ’³ Payment Form -->
        <div class="payment-form mb-5">
          <h4 class="mb-4"><i class="bi bi-credit-card"></i> Make Payment</h4>
          <form method="POST" class="row g-3">
            <div class="col-md-4">
              <label class="form-label fw-bold">EMI Amount (â‚¹)</label>
              <input type="number" name="emi_amount" step="0.01" min="1" 
                     class="form-control form-control-lg" 
                     value="{{ loan.insert_amount }}" required>
            </div>
            
            <div class="col-md-4">
              <label class="form-label fw-bold">Payment Date</label>
              <input type="date" name="payment_date" class="form-control form-control-lg" 
                     value="{{ current_date }}" required>
            </div>
            
            <div class="col-md-4 d-flex align-items-end">
              <button type="submit" class="btn btn-success btn-lg w-100 payment-btn">
                <i class="bi bi-check-circle"></i> Submit Payment
              </button>
            </div>
          </form>
        </div>

        <!-- ðŸ“Š EMI Progress -->
        <div class="progress mb-4" style="height: 20px;">
          <div class="progress-bar bg-success" role="progressbar" 
               style="width: {{ (1 - (remaining_principal / loan.loan_amount)) * 100 }}%;" 
               aria-valuenow="{{ (1 - (remaining_principal / loan.loan_amount)) * 100 }}" 
               aria-valuemin="0" aria-valuemax="100">
            {{ ((loan.loan_amount - remaining_principal) / loan.loan_amount * 100)|round(1) }}% Paid
          </div>
        </div>

        <!-- ðŸ§¾ EMI Breakdown Table -->
        <h4 class="mb-3"><i class="bi bi-receipt"></i> Payment History</h4>
        <div class="table-responsive">
          <table class="table table-bordered table-hover emi-table">
            <thead class="text-center">
              <tr>
                <th>Date</th>
                <th>Days</th>
                <th>Interest Accrued (â‚¹)</th>
                <th>Payment (â‚¹)</th>
                <th>Interest Paid (â‚¹)</th>
                <th>Principal Paid (â‚¹)</th>
                <th>Remaining Principal (â‚¹)</th>
              </tr>
            </thead>
            <tbody>
              {% for row in emi_table %}
                <tr>
                  <td>{{ row.date }}</td>
                  <td class="text-center">{{ row.days }}</td>
                  <td class="text-end">{{ row.interest|round(2) }}</td>
                  <td class="text-end fw-bold">{{ row.credit|round(2) }}</td>
                  <td class="text-end text-success">{{ row.interest_paid|round(2) }}</td>
                  <td class="text-end text-primary">{{ row.principal_paid|round(2) }}</td>
                  <td class="text-end fw-bold">{{ row.remaining_principal|round(2) }}</td>
                </tr>
              {% else %}
                <tr>
                  <td colspan="7" class="text-center py-4">
                    <i class="bi bi-info-circle"></i> No payments recorded yet
                  </td>
                </tr>
              {% endfor %}
            </tbody>
            <tfoot>
              <tr class="table-active">
                <th colspan="3" class="text-end">Totals:</th>
                <th class="text-end fw-bold">â‚¹{{ total_payments|round(2) }}</th>
                <th class="text-end fw-bold text-success">â‚¹{{ total_interest|round(2) }}</th>
                <th class="text-end fw-bold text-primary">â‚¹{{ total_principal|round(2) }}</th>
                <th></th>
              </tr>
            </tfoot>
          </table>
        </div>

        <div class="d-flex justify-content-between mt-4">
          <a href="{{ url_for('loan_details', loan_id=loan.id) }}" class="btn btn-outline-secondary no-print">
            <i class="bi bi-arrow-left"></i> Back to Loan Details
          </a>
          
          <button id="printBtn" class="btn btn-outline-primary no-print">
            <i class="bi bi-printer"></i> Print Statement
          </button>
        </div>
      </div>
      









      <!-- Print header (only visible when printing) -->
<div class="print-header">
  <h2>GPS Teacher Co-Operative Bank</h2>
  <h3>EMI Payment Statement</h3>
  <p>Loan ID: {{ loan.id }} | Customer: {{ loan.full_name }}</p>
  <p>Statement Date: {{ current_date }}</p>
</div>

<!-- Print footer (only visible when printing) -->
<div class="print-footer">
  <p>Generated on: {{ current_date }} | GPS Teacher Co-Operative Bank</p>
  <p>Branch: Bhalki, Karnataka | Contact: 123-456-7890</p>
  <p>This is a computer-generated statement and does not require a signature</p>
</div>







      <!-- Print footer (only visible when printing) -->
      <div class="print-footer">
        <p>Generated on: {{ current_date }} | GPS Teacher Co-Operative Bank</p>
        <p>Branch: Bhalki, Karnataka | Contact: 123-456-7890</p>
        <p>This is a computer-generated statement and does not require a signature</p>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Set default payment date to today
    document.addEventListener('DOMContentLoaded', function() {
      const today = new Date().toISOString().split('T')[0];
      document.querySelector('input[name="payment_date"]').value = today;
      
      // Add print functionality
      document.getElementById('printBtn').addEventListener('click', function() {
        window.print();
      });
    });
  </script>
</body>
</html>